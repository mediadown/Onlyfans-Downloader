import{aq as N,ar as B,aj as R}from"./index-SSvFfhA5.js";const V=()=>{if(window.isOFDownloaderInjected)return;window.isOFDownloaderInjected=!0;const d=new Set,O=new Set,S=new Set;let k=!1,E=[];const _=t=>{const a=document.querySelector("#app");if(console.log("[OFDownloader] showToast",t,a),!a)return;const o=a.__vue__&&a.__vue__.showToast;o&&o(t)};function w(t,a){const o=t.querySelector("use"),e=o.href.baseVal;a?(t.setAttribute("disbaled","true"),o.setAttribute("href",e.replace("icon-download","icon-loading"))):(t.removeAttribute("disabled"),o.setAttribute("href",e.replace("icon-loading","icon-download")))}window.addEventListener("replyInvokeTasks",t=>{const{detail:a}=t;if(console.log("[OFDownloader] replyInvokeTasks",t),!a)return;const{type:o,options:e}=a;o==="alert"&&(typeof e=="object"&&e.buttons&&e.buttons.forEach(s=>{s.onclickEvent&&(console.log("[OFDownloader] button.onclickEvent",s.onclickEvent),s.onclick=()=>{const c=new CustomEvent("alertConfirm",{detail:{type:s.onclickEvent}});window.dispatchEvent(c)}),!s.onclick&&(s.onclick=()=>{})}),window.alert(e)),o==="toast"&&_(e)}),console.log("[OFDownloader] injectDlButton");const F=new MutationObserver(t=>{for(const a of t){if(a.addedNodes)for(let o=0;o<a.addedNodes.length;o++){const e=a.addedNodes[o];if(e.classList&&e.classList.contains("b-chats__conversations-content")){const s=e.querySelector(".b-chat");s&&!k&&(k=!0,new MutationObserver(l=>{for(const u of l)if(u.addedNodes)for(let r=0;r<u.addedNodes.length;r++){const i=u.addedNodes[r];i.classList&&i.classList.contains("b-chat__item-message")&&i.querySelectorAll(".b-chat__message__content").forEach(h=>{S.add(h)}),i.parentElement&&i.parentElement.classList&&i.parentElement.classList.contains("b-chat__item-message")&&(console.log("[OFDownloader] chat.itemMessageChildren",i),i.parentElement.querySelectorAll(".b-chat__message__content").forEach(h=>{S.add(h)}))}S.forEach(u=>{A(u)})}).observe(s,{childList:!0,subtree:!0,attributes:!0}))}e.nodeType===Node.ELEMENT_NODE&&(e.classList&&e.classList.contains("b-post__wrapper")&&d.add(e),e.querySelectorAll&&(e.querySelectorAll(".b-post__wrapper").forEach(l=>d.add(l)),e.querySelector(".b-chats")||(k=!1)),e.classList&&(e.classList.contains("vue-recycle-scroller__item-view")||e.classList.contains("dynamic-scroller-item")||e.classList.contains("g-sides-gaps")||e.classList.contains("dynamic-scroller-item-homepage-feed")||e.classList.contains("b-profile__feed")||e.classList.contains("b-tabs__panel")||e.classList.contains("b-feed"))&&(e.querySelectorAll(".b-post__wrapper").forEach(c=>d.add(c)),e.parentNode&&e.parentNode.querySelectorAll(".b-post__wrapper").forEach(l=>d.add(l))))}if(a.type==="attributes"&&a.target.nodeType===Node.ELEMENT_NODE){const o=a.target;if(o.classList&&o.classList.contains("b-post__wrapper")&&d.add(o),o.classList&&(o.classList.contains("b-post__content")||o.classList.contains("m-post-has-media"))){const e=o.closest(".b-post__wrapper");e&&d.add(e)}o.classList&&o.classList.contains("pswp")&&O.add(o)}}d.forEach(a=>{var s,c;const o=((c=(s=a.querySelector(".g-user-username"))==null?void 0:s.textContent)==null?void 0:c.trim().substring(1))||"user_unknown",e=a.querySelector(".b-post__media__item-inner, div[at-attr='media_locator']");e&&(e.onclick=l=>{l.stopPropagation(),l.preventDefault();const u=e.__vue__&&e.__vue__._props;if(u){const r=u.post;E=m(r,o),console.log("[OFDownloader] pswpPendingTasks",E)}else E=[]}),T(a)}),O.forEach(a=>{q(a)})});function T(t){var y,b,p;if(t.querySelector(".feed-dl-btn"))return;const o=t.__vue__&&t.__vue__._props;if(console.log("[OFDownloader] addDLButtonToFeed.props",o),o){const n=o.post,g=Reflect.has(n,"canViewMedia")?n.canViewMedia:!0,L=Reflect.has(n,"isMediaReady")?n.isMediaReady:!0,v=Reflect.has(n,"mediaCount")?n.mediaCount>0:Reflect.has(n,"media")?n.media.length>0:!1,D=Reflect.has(n,"linkedPosts")?(y=n.linkedPosts)==null?void 0:y.length:Reflect.has(n,"linkedUsers")?(b=n.linkedUsers)==null?void 0:b.length:!1;if(!g&&console.warn("[OFDownloader] can't view media",n),!L&&console.warn("[OFDownloader] media is not ready",n),!v&&console.warn("[OFDownloader] no media",n),D&&console.warn("[OFDownloader] is embedded",n),D||!g||!L||!v){d.delete(t);return}}else{const n=t.querySelector(".b-post__content"),g=!!(n!=null&&n.querySelector(".b-post__unknown")),L=!!(n!=null&&n.querySelector(".m-not-allowed")),v=n==null?void 0:n.classList.contains("m-post-has-media");if(!g&&console.warn("[OFDownloader] is unknown",n),!v&&console.warn("[OFDownloader] no media",n),!L&&console.warn("[OFDownloader] is not allowed",n),g||!v||L){d.delete(t);return}}const e=t.querySelectorAll(".b-post__tools");if(e.length===0)return;const s=e[e.length-1],c=(p=s==null?void 0:s.querySelector(".b-post__tools__item .send-tip-btn"))==null?void 0:p.parentNode,l=c==null?void 0:c.cloneNode(!0);if(!l)return;const u=l.querySelector("button"),r=u.querySelector("svg"),i=r.querySelector("use"),f=i.getAttribute("href"),h=u.querySelector(".b-post__tools__btn-text");u.classList.replace("send-tip-btn","feed-dl-btn"),r.setAttribute("data-icon-name","icon-download"),i.setAttribute("href",f.replace("icon-funds","icon-download")),i.setAttribute("xlink:href",f.replace("icon-funds","icon-download")),h.innerText="DOWNLOAD",u.removeAttribute("disabled"),u.addEventListener("click",async n=>{var g,L;n.stopPropagation(),n.preventDefault();try{const v=((L=(g=t.querySelector(".g-user-username"))==null?void 0:g.textContent)==null?void 0:L.trim().substring(1))||"user_unknown";if(o){const D=m(o.post,v);console.log("[OFDownloader] penddingTasks",D),w(u,!0),await x(D),w(u,!1)}else throw new Error("[OFDownloader] is not a vue component.")}catch(v){console.error("[OFDownloader] addDLButtonToFeed.error",v);const D=t.querySelector(".b-post__date"),M=D==null?void 0:D.getAttribute("href");console.log("[OFDownloader] postHref",M)}}),s==null||s.insertBefore(l,c==null?void 0:c.nextSibling),d.delete(t)}function m(t,a){const o=[],{id:e,responseType:s,media:c,text:l}=t,u="postedAt"in t?t.postedAt:"createdAt"in t?t.createdAt:"";for(const r of c){if(!r.canView){console.warn("[OFDownloader] 无法查看媒体",r);continue}const f=r.id,h=r.type,y=r.duration;if(r.files.drm){const p=r.files.drm.manifest.dash,n=r.files.drm.signature.dash;o.push({id:e,username:a,responseType:s,dateString:u,mid:f,mediaType:h,duration:y,url:p,signature:n,text:l})}else{const p=r.files.full.url,n=r.files.preview.url;if(!p&&!n){console.warn("[OFDownloader] can't get full or preview url",r);continue}const g=p?r.files.full.url:r.files.preview.url,L=r.files.full.width,v=r.files.full.height;o.push({id:e,username:a,responseType:s,dateString:u,mid:f,mediaType:h,duration:y,url:g,width:L,height:v,text:l})}}return o}function q(t){var u;const a=t.querySelector(".pswp-dl-btn");if(a){const r=t.querySelector(".pswp__item[aria-hidden='false']");if(r){const i=r.querySelector("img"),f=r.querySelector("video");if(!i&&!f){console.warn("[OFDownloader] pswp.activeItem is not a image or video",r),t.removeChild(a),O.delete(t);return}}else{console.warn("[OFDownloader] pswp.activeItem is not found",t),t.removeChild(a),O.delete(t);return}return}const o=(u=document.querySelector("link[rel='icon']"))==null?void 0:u.getAttribute("href"),e=new URL(o).pathname.split("/").slice(0,-1).join("/"),s=document.createElement("button");s.classList.add("m-size-lg-hover","m-with-round-hover","g-btn","m-rounded","m-lg","pswp-dl-btn"),s.style.position="absolute",s.style.top="40px",s.style.left="40px",s.style.minWidth="fit-content",s.style.padding="16px";const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.classList.add("g-icon","m-lg");const l=document.createElementNS("http://www.w3.org/2000/svg","use");l.setAttribute("href",`${e}/sprite.svg#icon-download`),l.setAttribute("xlink:href",`${e}/sprite.svg#icon-download`),s.appendChild(c),c.appendChild(l),s.addEventListener("click",async r=>{r.stopPropagation(),r.preventDefault(),console.log("[OFDownloader] pswpPendingTasks",E);const i=t.querySelector(".pswp__item[aria-hidden='false']");if(!i){console.error("[OFDownloader] pswp.activeItem is not found when click dlButton",t);return}const f=i.querySelector("img"),h=i.querySelector("video");if(!f&&!h){console.error("[OFDownloader] pswp.activeItem is not a image or video when click dlButton",i);return}if(h){const y=h.__vue__&&h.__vue__._props;if(y){const b=y.media.id,p=E.find(n=>n.mid===b);p&&(console.log("[OFDownloader] targetPendingTask",p),w(s,!0),await x([p]),w(s,!1))}}else if(f){const y=f.getAttribute("src"),b=E.find(p=>p.url===y);b?(console.log("[OFDownloader] targetPendingTask",b),w(s,!0),await x([b]),w(s,!1)):alert({title:"OFDownloader: Incorrect media",message:"Please copy the post link and contact us to support. Thank you."})}else alert({title:"OFDownloader: Incorrect media",message:"Please copy the post link and contact us to support. Thank you."})}),t.appendChild(s),O.delete(t)}function A(t){var y;if(t.querySelector(".chat-dl-btn"))return;const o=t.querySelector(".b-post__media__item-inner, div[at-attr='media_locator']");if(!o)return;const e=o.__vue__&&o.__vue__._props;if(e&&!(Reflect.has(e.message,"media")&&e.message.media.some(p=>Reflect.has(p,"canView")?p.canView:!0))){console.warn("[OFDownloader] no valid media",e);return}const s=o.classList.contains("m-video"),c=o.classList.contains("m-gif"),l=o.classList.contains("m-photo");if(!s&&!c&&!l){console.warn("[OFDownloader] no video or gif or image",o);return}const u=(y=document.querySelector("link[rel='icon']"))==null?void 0:y.getAttribute("href"),r=new URL(u).pathname.split("/").slice(0,-1).join("/"),i=document.createElement("button");i.classList.add("m-with-round-hover","g-btn","m-rounded","chat-dl-btn"),i.style.position="absolute",i.style.bottom="0",i.style.right="-60px",i.style.minWidth="fit-content";const f=document.createElementNS("http://www.w3.org/2000/svg","svg");f.classList.add("g-icon");const h=document.createElementNS("http://www.w3.org/2000/svg","use");h.setAttribute("href",`${r}/sprite.svg#icon-download`),h.setAttribute("xlink:href",`${r}/sprite.svg#icon-download`),i.appendChild(f),f.appendChild(h),t.appendChild(i),i.addEventListener("click",async b=>{var p,n;b.stopPropagation(),b.preventDefault();try{const g=[],L=((n=(p=t.querySelector(".g-avatar"))==null?void 0:p.getAttribute("href"))==null?void 0:n.trim().substring(1))||"user_unknown";if(e){console.log("[OFDownloader] props",e);const v=e.entityType;if(v==="post"){const D=e.post;g.push(...m(D,L))}if(v==="message"){const D=e.message;g.push(...m(D,L))}w(i,!0),await x(g),w(i,!1),console.log("[OFDownloader] penddingTasks",g)}else console.log("[OFDownloader] no props",t),console.log("[OFDownloader] isVideo",s),console.log("[OFDownloader] isGif",c),console.log("[OFDownloader] isImage",l)}catch{}}),S.delete(t)}function P(){document.querySelectorAll(".b-post__wrapper").forEach(a=>T(a))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",P):P(),F.observe(document.body,{attributes:!0,attributeFilter:["class","style"],childList:!0,subtree:!0});async function x(t){return new Promise(a=>{try{const o=new CustomEvent("invokeTasks",{detail:t});window.dispatchEvent(o);const e=()=>{window.removeEventListener("taskProcessed",e),a()};window.addEventListener("taskProcessed",e)}catch(o){console.error("[OFDownloader] invokeTasks error",o),alert("Please try again later, or contact support.")}})}},I=()=>{const d="DAILY_TIMESTAMP";return chrome.storage.local.get(d).then(O=>{const S=O[d];let k=Date.now();if(S&&!(new Date(k).getDay()>new Date(S).getDay()))return;const E=document.querySelector("#diff-modal");if(E){E.classList.add("show");return}chrome.storage.local.set({[d]:k});const _=new DOMParser,w=document.createDocumentFragment(),F=document.createElement("div");F.classList.add("modal","fade","show"),F.id="diff-modal",w.append(F);const T=document.createElement("div");T.classList.add("modal-dialog","modal-lg","modal-dialog-centered"),F.append(T);const m=document.createElement("div");m.classList.add("modal-content"),T.append(m);const q=document.createElement("header");q.classList.add("modal-header","g-border-bottom"),m.append(q);const A=document.createElement("h4");A.classList.add("modal-title","d-flex","align-items-center"),A.textContent="Onlyfans Downloader",q.append(A);const P=`
      <div class="g-avatar g-icon has-story mr-1">
      <div data-v-78bd6e0d class="g-avatar__img-wrapper">
        <img style="width: 100%;" src="${chrome.runtime.getURL("src/assets/ofol/icon48.png")}"/>
      </div>
      </div>
    `;A.prepend(_.parseFromString(P,"text/html").body.firstElementChild);const t=_.parseFromString(`
    <button data-v-583fb90a type="button" at-attr="close_btn" class="l-sidebar__btn-close m-with-round-hover g-btn m-with-round-hover m-icon m-icon-only m-gray m-sm-size">
      <svg data-v-583fb90a="" class="g-icon" data-icon-name="icon-close" aria-hidden="true">
        <use href="/theme/onlyfans/spa/icons/sprite.svg?rev=202306261027-6fa8a11695#icon-close" xlink:href="/theme/onlyfans/spa/icons/sprite.svg?rev=202306261027-6fa8a11695#icon-close"></use>
      </svg>
    </button>
    `,"text/html").body.firstElementChild;t.addEventListener("click",()=>F.classList.remove("show")),q.append(t);const a=document.createElement("div");m.id="",a.classList.add("modal-body","d-flex","flex-row"),m.append(a),a.append(_.parseFromString(`
      <div class="w-50 px-3">
        <h4 class="text-center">Free Version</h4>
        <ul class="gray-list px-4">
          <p>✔️ ≤ 2 Videos</p>
          <p>✔️ ≤ 10 Photos</p>
        </ul>
      </div>
    `,"text/html").body.firstElementChild),a.append(_.parseFromString(`
      <div class="w-50 px-3">
        <h4 class="text-center">Pro Version</h4>
        <ul class="gray-list px-4">
          <p>✅ Unlimit Videos</p>
          <p>✅ Unlimit Photos</p>
          <p>✅ Download Messages Content</p>
          <p>✅ Support Time Period Download</p>
        </ul>
      </div>
    `,"text/html").body.firstElementChild);const s=document.createElement("footer");s.classList.add("modal-footer","g-border-top","justify-content-around"),m.append(s);const c=document.createElement("button");c.classList.add("g-btn","m-flat","m-btn-gaps","m-reset-width"),c.textContent="Use Free Version",c.addEventListener("click",()=>F.classList.remove("show")),s.append(c);const l=document.createElement("button");l.classList.add("g-btn","m-rounded","m-reset-width"),l.textContent="UPGRADE NOW!!",l.addEventListener("click",()=>{chrome.runtime.sendMessage({command:"ToSubscription"}),F.classList.remove("show")}),s.append(l),document.body.append(w)})};chrome.runtime.onMessage.addListener((d,O,S)=>{const{command:k,payload:E}=d;if(k==="ToSubscription"&&N("subscribe"),k==="Download"){const{url:_,filename:w}=E;chrome.downloads.download({url:_,filename:w})}return k==="ToHomesite"&&chrome.tabs.create({url:"https://hlsdownloader.com/"}),k==="updateQuota"&&B().then(_=>S(_)),!0});let C=[];chrome.tabs.onUpdated.addListener(async(d,O,S)=>{var _,w,F,T;if(O.status==="complete"&&((_=S.url)==null?void 0:_.indexOf("onlyfans.com"))!==-1&&await chrome.scripting.executeScript({target:{tabId:d},func:V,world:"MAIN"}),!((w=R.value)!=null&&w.isPro||!((F=await chrome.cookies.get({url:"https://onlyfans.com",name:"auth_id"}))==null?void 0:F.value))&&O.status==="complete"&&(T=S.url)!=null&&T.includes("onlyfans.com")){if(C.includes(d))return;try{const m=await chrome.tabs.get(d);if(!(m!=null&&m.active))return;await chrome.scripting.executeScript({target:{tabId:d},func:I}),C.push(d)}catch(m){console.log("Injection failed:",m),C=C.filter(q=>q!==d)}}});chrome.runtime.onInstalled.addListener(async d=>{d.reason==chrome.runtime.OnInstalledReason.INSTALL&&N("/")});chrome.action.onClicked.addListener(()=>{N("/")});
