function p(){window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"alert",options:{title:"OFDownloader: No Quota",message:"Free quota is not enough, you can upgrade account(<strong>3 days free trial</strong>) now.",html:!0,hideCloseBtn:!1,buttons:[{title:"Upgrade",onclickEvent:"TO_SUBSCRIBE",closeOnClick:!0}]}}})),window.dispatchEvent(new CustomEvent("taskProcessed"))}window.addEventListener("invokeTasks",async n=>{const{detail:a}=n;console.log("[OFDownloader] invokeTasks",a);let{userState:e}=await chrome.storage.local.get("userState");e=e?typeof e=="string"?JSON.parse(e):e:!1;let t=e?e.quota:0;const l=e&&e.isPro,r=e&&e.token!=="";if(!r){const{freeQuota:o}=await chrome.storage.local.get("freeQuota");o!==void 0?t=o:(chrome.storage.local.set({freeQuota:2}),t=2)}if(console.log("[OFDownloader] isPro",l),console.log("[OFDownloader] quota",t),console.log("[OFDownloader] isAuthenticated",r),!l&&t<=0){p();return}const i=a,d=i.some(o=>o.signature);if(console.log("[OFDownloader] hasDRM",d),d&&(console.log("[OFDownloader] hasDRM.replyInvokeTasks"),window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"alert",options:{title:"OFDownloader",message:"It contains DRM protected resources, use the desktop app to download?",html:!1,hideCloseBtn:!0,buttons:[{title:"Ignore",closeOnClick:!0},{title:"Get Desktop App",onclickEvent:"TO_HOMESITE",closeOnClick:!0}]}}}))),!r)chrome.storage.local.set({freeQuota:t-1});else if(!l&&!await chrome.runtime.sendMessage({command:"updateQuota"})){console.log("[OFDownloader] updateQuota failed"),p();return}let c=!1;for(const o of i)if(!o.signature)try{const{setting:s}=await chrome.storage.local.get("settings"),w=(s==null?void 0:s.isSortByDate)??!1,m=new URL(o.url).pathname.split("/").pop(),u=[o.username,o.mediaType,m];w&&u.splice(1,0,o.dateString.split("T")[0]);const g=u.join("/");chrome.runtime.sendMessage({command:"Download",payload:{url:o.url,filename:g}}),c=!0}catch(s){console.error("[OFDownloader] download error",s),window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"alert",options:{title:"OFDownloader",message:"Something went wrong, please try again or contact support.",html:!1,hideCloseBtn:!0}}}))}c&&window.dispatchEvent(new CustomEvent("replyInvokeTasks",{detail:{type:"toast",options:"Added to download list."}})),window.dispatchEvent(new CustomEvent("taskProcessed"))});window.addEventListener("alertConfirm",async n=>{console.log("[OFDownloader] alertConfirm",n);const{detail:a}=n,{type:e}=a;e==="TO_SUBSCRIBE"&&chrome.runtime.sendMessage({command:"ToSubscription"}),e==="TO_HOMESITE"&&chrome.runtime.sendMessage({command:"ToHomesite"})});
